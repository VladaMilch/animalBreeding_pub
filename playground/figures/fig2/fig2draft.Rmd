---
title: "Figure 2 drafts (Achim's suggestion)"
author: "Vlada Milchevskaya"
#date: "11.11.20"
output: 
    prettydoc::html_pretty:
        toc: true
        theme: cayman
        highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library("animalBreeding")
library(ggplot2)
library(ggpubr)
library(fields)
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
source("../fig4_other/helper_functions.R")
```

There are several options for each figure suggestion.

# Fig. 2A

The level plot reflects the minimal number of breedings (not litters) required to achieve at least X offsprings (x axis) with the success probability Y (y axis). 


```{r, eval = TRUE, echo=FALSE}
ff_A <- function(X, Y){
  res <- breed_genotype(confidence_p = Y, 
               effective_fertility_p = 0.7, 
               genotypes_p = c(0.25,0.5,0.25), 
              egenotypes_N = c(X, 0, 0), 
               litter_mean = 7, method = "poisson")
  cat(X)
  cat('\n')
  cat(Y)
  cat('\n')
  cat("####################")
  cat('\n')
  cat('\n')
  return(res)
}

red_noffs <- seq(2,100,1)
confi_grid <- c(0.5, 0.6, 0.7, 0.8, 0.85, 0.9, 
                0.91, 0.92, 0.93, 0.94, 0.95, 0.96, 0.97, 
                0.975, 0.98, 0.985, 0.99, 0.995, 
                0.996, 0.997, 0.998, 0.999)
confi_grid2 <- seq(0.8,0.995,0.01)
length(red_noffs)
length(confi_grid)
length(confi_grid2)
```

```{r, eval = FALSE}
# # warning! long!
# req_breedings <- sapply(red_noffs, function(noff){
#   sapply(confi_grid, function(cc){
#     ff_A(X=noff,Y=cc)
#   })
# })
# 
# data4a <- cbind(expand.grid(red_noffs, confi_grid), as.vector(t(req_breedings)))
# colnames(data4a) <- c("offsprings",  "confidence", "breedings")
# save(req_breedings, data4a, file = "data4a.Rdata")

# warning! long!
# req_breedings2 <- sapply(red_noffs, function(noff){
#   sapply(confi_grid2, function(cc){
#     ff_A(X=noff,Y=cc)
#   })
# })
# 
# dim(req_breedings2)
# 
# data4a_2 <- cbind(expand.grid(red_noffs, confi_grid2), as.vector(t(req_breedings2)))
# colnames(data4a_2) <- c("offsprings",  "confidence", "breedings")
# save(req_breedings2, confi_grid2, red_noffs, data4a_2, file = "data4a_2.Rdata")
```

1. Standart plot contour (beware, there is smoothing inside the contour function):

```{r}
load("data4a.Rdata")
load("data4a_2.Rdata")

contour(x = red_noffs, y = confi_grid, z = t(req_breedings), 
        xlab = "desired number of offsprings (p=0.25)",
        ylab = "success probability", ylim = c(0.5,1.001),
        main="Required number of breedings for a setup with \n average litter 7 and average fertility 70%")
```

```{r, eval = FALSE}
# the second confidence grid is worse than the first, we will omit it
contour(x = red_noffs, y = (confi_grid2), z = t(req_breedings2), 
        xlab = "desired number of offsprings (p=0.25)",
        ylab = "success probability",
        main="Required number of breedings for a setup with \n average litter 7 and average fertility 70%")

```

```{r}
library(ggplot2)
head(data4a)
plot1 <- ggplot(data4a, aes(x = offsprings, y = confidence, z = breedings)) +
         geom_contour(aes(colour=..level..)) + theme_pubr() +  
  ggtitle("Required number of breedings for a setup with \n average litter 7 and average fertility 70%")+
  xlab("desired number of offsprings (p=0.25)")+
  ylab("success probability")

plot1
library(directlabels)
my.dl <- list(box.color=NA, "draw.rects")
plot2A <- direct.label(plot1, list("far.from.others.borders","calc.boxes", "enlarge.box", "my.dl")) 
# plot6 <- direct.label(plot1, 'angled.boxes')
# plot7 <- direct.label(plot1, "smart.grid")
# plot6
plot2A
ggsave(plot = plot2A, filename = "plot_2A_annotated.pdf")
```

```{r plotly, eval = FALSE}
# library(plotly)
# 
# fig2 <- plot_ly(x = red_noffs[1:20], 
#                y = confi_grid2,
#                z = ~(req_breedings2)[,1:20],
#                type = "contour", 
#                contours = list(showlabels = TRUE, end = 100, size=5, start=5),
#                line = list(smoothing = 10))
# fig2 <- fig2 %>% colorbar(title = "Elevation \n in meters")
# 
# fig2
# 
# yaxis = list( 
#   tickmode = 'array',
#   tickvals = rescaled_y,
#   ticktext = confi_grid
#     )
# fig <- fig %>% layout(yaxis = yaxis)
# fig


# dim(req_breedings)
# 
# fig2 <- plot_ly(
#   type = "contour", 
#   z = matrix(c(2, 4, 7, 12, 13, 14, 15, 16, 3, 1, 6, 11, 12, 13, 
#                16, 17, 4, 2, 7, 7, 11, 14, 17, 18, 5, 3, 8, 8, 13, 
#                15, 18, 19, 7, 4, 10, 9, 16, 18, 20, 19, 9, 10, 5, 27, 
#                23, 21, 21, 21, 11, 14, 17, 26, 25, 24, 23, 22), 
#              nrow=7, ncol=8),
#   autocontour = TRUE, 
#   contours = list(
#     end = 26, 
#     size = 2, 
#     start = 2
#   ), 
#   line = list(smoothing = 0.85)
# ) 
fig2
```


# Fig. 2C

- Confidence: 90%
 
- Litter mean: 7

- Fertility: 70%

- Probabilities of the genotypes A and B: 25%, 25%


```{r}
offsA = seq(2,100,2)
offsB = seq(2,100,2)
df <- expand.grid(offsA, offsB)
ff_C <- function(nA, nB){
  breed_genotype(
    confidence_p = 0.9, 
    effective_fertility_p = 0.7, 
    genotypes_p = c(0.25, 0.5, 0.25), genotypes_N = c(nA, 0, nB), 
    litter_mean = 7)
}
```

```{r, eval = FALSE}
breedingsB <- apply(df, 1, function(x)ff_C(nA = x[1],nB = x[2]))
dfB <- cbind(df, breedingsB)
breeM = matrix(breedingsB, nrow = 50, ncol = 50)
#save(breedingsB, dfB, breeM, file = "data4c.Rdata")
```

```{r}
load("data4c.Rdata")
head(dfB)
plot2c <- ggplot(dfB, aes(x = Var1, y = Var2, z = breedingsB)) +
         geom_contour(aes(colour=..level..)) + theme_pubr() +  
  ggtitle("Required number of breedings for a setup with \n average litter 7 and average fertility 70%")+
  xlab("required number of offsprings of genotype A (p=0.25)")+
  ylab("required number of offsprings of genotype B (p=0.25)") + 
  scale_x_continuous(limits=c(0, 100), breaks = seq(0,100,25)) +
  scale_y_continuous(limits=c(0, 100), breaks = seq(0,100,25)) 

plot2c
my.dl <- list(box.color=NA, "draw.rects")
plot2C <- direct.label(plot2c, list("far.from.others.borders","calc.boxes", "my.dl")) 
plot7 <- direct.label(plot2c, "smart.grid")
plot2C
ggsave(plot = plot2C, filename = "plot_2C_annotated.pdf", width = 7, height = 7)
```





# Fig 2B

```{r, eval = FALSE}
source("../fig4_other/helper_functions.R")
req_pups <- seq(2,100,1)
data4b_prelim <- calc_data4fig4(
    req_pups,
    genotype_probability = 1, 
    confiP = 0.9, 
    effertyP = 0.7, litmean = 7)
surplus_pois <- round(
    100*(data4b_prelim$req_poisson-xx$req_mendel)/xx$req_mendel)
surplus_fest <- round(
    100*(data4b_prelim$req_festing-xx$req_mendel)/xx$req_mendel)
animals_saved_fp_percent <- round(
    100*(data4b_prelim$req_festing-xx$req_poisson)/xx$req_festing)

data4b <- data.frame(
    data4b_prelim, 
    animals_saved_fp_percent)
save(data4b, file = "data4b.Rdata")
```



```{r}
load("data4b.Rdata")
animals_saved_pf_percent <- round(
    100*(data4b$req_festing-data4b$req_poisson)/data4b$req_poisson)

data4b <- data.frame(
    data4b, 
    animals_saved_pf_percent)

plot2B_hist <- ggplot(data4b,
                      aes(x=req_pups, y=animals_saved_pf_percent))+
  geom_bar(stat="identity",col="darkgrey")  + 
  theme_pubr() + 
  #theme(axis.title.x = element_blank(), axis.text.x = element_blank()) + 
  ylab("Percent saved \n animals")

ggsave(plot2B_hist, 
       filename = "plot2B_hist_annotated.pdf", width = 7, height = 5)

plot2B_contour <- 
  ggplot(data = data4b , aes(x=req_pups, y = animals_saved_fp_percent)) + 
  #geom_point(aes(y=req_br_festing50, col = "Festing 50%"), colour = "red", alpha=0.5, size=0.5) + 
  #geom_line(aes(y=req_br_festing50, col = "Festing 50%"), alpha=0.3, size=0.3) + 
  #geom_point(aes(y=req_br_festing90, col = "Festing 90%")) +
  geom_point(aes(y= req_poisson, col = "poisson")) + 
  geom_point(aes(y=req_festing, col = "festing")) + 
  geom_point(aes(y=req_mendel, col = "mendel")) + 
  labs(x="Required number of pups",
       y = "Smallest number \n of breedings",
       caption = "Mean litter size: 7,  Effective fertility: 70%",
       title = "Model comparison for the smallest required number of breegins", colour = "") +
  #labs(x='',y='',title='',colour = "Method") +
  theme_pubr() +  theme(legend.position = c(0.85, 0.25))

ggsave(plot2B_contour, filename = "plot2B_contour_annotated.pdf", width = 7, height = 7)


plot2B <- ggarrange(
  plotlist = list(plot2B_hist, plot2B_contour), ncol = 1, 
  heights = c(1,3))
plot2B
ggsave(plot2B, filename = "plot2B_annotated.pdf", width = 7, height = 7)

```

```{r}
# xx = fe70[[1]]
# surplus_pois <- round(100*(xx$req_poisson-xx$req_mendel)/xx$req_mendel)
# surplus_fest <- round(100*(xx$req_festing-xx$req_mendel)/xx$req_mendel)
# yy <- data.frame(xx, surplus_pois, surplus_fest)
# 
# barplot(yy$surplus_fest, yy$surplus_pois)
# 
# library(lattice)
# zz <- t(yy)
# colnames(zz) <- yy$req_pups
# rownames(zz[c(4,2,3),])
# 
# barplot(zz[c(4,2,3),], beside = TRUE, 
#         ylab="required number of of breedings", 
#         xlab = "number of pups required (mendel, pois, festing)")
# 
# 
# rownames(zz[c(5,6),])
# barplot(zz[c(5,6),], beside = TRUE, 
#         ylab="surplus % breedings relative to Mendel", 
#         xlab = "number of pups required (pois, festing)")

```

```{r, eval = FALSE}
# calculate surplus of animals:
# 1st: for a given n breedings, fertility etc. calculate the expected of N born
# 2nd: 

expect_born_poisson <- function(
  effective_fertility_p,
  n_breedings,
  litter_mean
){
  freqs_r <- dpois(x = seq(1,round(4*litter_mean), 1), lambda = litter_mean)
  freqs <- freqs_r/sum(freqs_r)
  supp1 = as.numeric(c(0, seq(1,round(4*litter_mean))))
  prob1 <- c(1-effective_fertility_p, effective_fertility_p*freqs)
  stopifnot(sum(prob1)==1)
  
  #search_interval <- seq(1,10)
  doof1 <- distr::DiscreteDistribution(supp = supp1, prob = prob1)
  doofN <- distr::convpow(doof1, N=n_breedings)
  return(doofN)
}

ff <- function(xx){
  distrConv <- expect_born_poisson(effective_fertility_p = 0.7, n_breedings = xx, litter_mean = 7)
  # plot(distrConv@d(x = distrConv@support))
  return(  median(distrConv@r(n = 10000) )
)

}

surplus_animals_born <- 100*(sapply(fe70[[1]]$req_poisson, ff) - fe70[[1]]$req_pups)/  fe70[[1]]$req_pups
plot(fe70[[1]]$req_pups, surplus_animals_born)



confidence_grid <- c(0.5, 0.7, 0.8, 0.9, 0.95, 0.975)
req_pups_grid <- c(10,25,50,100,200,300)
gp_grid <- c(1, 0.5, 0.25, 0.125, 0.0625) # genotype probability


breed_genotype(confidence_p = 0.6, effective_fertility_p = 0.7, genotypes_p = c(1,0), genotypes_N = c(200,0), litter_mean = 7)
calculate_needed_breedings(confidence_p = 0.6, effective_fertility_p = 0.7, n_needed = 200, litter_mean = 7, method = "poisson")
```

```{r, eval = FALSE}
ooo <- sapply(
  confidence_grid, FUN = function(x){
    sapply(req_pups_grid, FUN = function(y){
      cat(x);      cat("\n")
      cat(y);       cat("\n")
      cat("\n")
      breed_genotype(
        confidence_p = x, 
        effective_fertility_p = 0.7, 
        genotypes_p = c(0.25,0.75), genotypes_N = c(y,0),
        litter_mean = 7, 
        method = "poisson")
    })
  })
save(ooo, file = "./data4heatmap_surplus.Rdata")
```

```{r, eval = FALSE}
load("data4heatmap_surplus.Rdata")
data <- expand.grid(X=paste0(confidence_grid*100,"%"), 
                    Y=as.character(req_pups_grid))
data$Z <- as.numeric(t(ooo))
# new column: text for tooltip:
data <- data %>%
  mutate(text = paste0("confidence: ", X, "\n", "pups: ", Y, "\n", "breedings: ",round(Z,2), "\n", "What else?"))

# classic ggplot, with text in aes
p <- ggplot(data, aes(X, Y, fill= Z, text=text)) + 
  geom_tile() +
  hrbrthemes::theme_ipsum()

plotly::ggplotly(p, tooltip="text")

length(confidence_grid)
colnames(ooo) <- paste0("c",confidence_grid*100)
rownames(ooo) <- paste0("p",req_pups_grid)

gplots::heatmap.2(ooo,dendrogram='none', Rowv=FALSE, Colv=FALSE,trace='none', )

```

# Fig 2D


```{r, eval = FALSE}
req_pups_grid <- seq(2, 100, 1)

data4d <- sapply(req_pups_grid, FUN = function(y){
      cat(y);       cat("\n")
      cat("\n")
      b_only1gender = breed_genotype(
        confidence_p = 0.9, 
        effective_fertility_p = 0.7, 
        genotypes_p = c(0.5,0.5), genotypes_N = c(2*y,0),
        litter_mean = 7, 
        method = "poisson")
      b_balanced = breed_genotype(
        confidence_p = 0.9, 
        effective_fertility_p = 0.7, 
        genotypes_p = c(0.5,0.5), genotypes_N = c(y,y),
        litter_mean = 7, 
        method = "poisson")
    b_anygender = breed_genotype(
        confidence_p = 0.9, 
        effective_fertility_p = 0.7, 
        genotypes_p = c(1,0), genotypes_N = c(2*y,0),
        litter_mean = 7, 
        method = "poisson")
    return(c(b_balanced, b_anygender, b_only1gender))
    })

rownames(data4d)[1:3] <- c("b_balanced", "b_anysex", "b_only1sex")
data4d <- rbind(data4d, req_pups_grid)
data4d_t = t(data4d)[,1:4]
save(data4d_t, file = "data4d.Rdata")
data4d_t
```


```{r}
# not gender, sex!

load("data4d.Rdata")
data4d_t = data.frame(data4d_t)
plot(x=data4d_t$req_pups_grid, y = data4d_t$b_only1gender) 
points(x=data4d_t$req_pups_grid, y = data4d_t$b_anygender, col = "red") 
points(x=data4d_t$req_pups_grid, y = data4d_t$b_balanced, col = "blue") 

data4d_t

pp <- 
  ggplot(data = data4d_t[1:50,] , aes(x=req_pups_grid*2)) + 
  geom_point(aes(y= b_only1sex, col = "all F/ all M")) + 
  geom_point(aes(y=b_anysex, col = "F + M = Total")) + 
  geom_point(aes(y=b_balanced, col = "F = M = Total/2")) + 
  # labs(x="Required number of pups", 
  #      y = "Smallest number \n of breedings", 
  #      caption = "Mean litter size: 7,  Effective fertility: 70%", 
  #      title = "Model comparison for the smallest required number of breegins", colour = "Method") + 
  labs(x='',y='',title='',colour = "Offspring sex") +
  theme_pubr()   + theme(legend.position="right") + 
  theme(legend.position = c(0.3,0.8))

plot2D <- pp + scale_x_continuous(name="Total # offsprings", 
                                  limits=c(0, 102), breaks = seq(0,100,10)) 
plot2Dann <- plot2D +   labs(
       y = "Smallest number \n of breedings",
       caption = "Mean litter size: 7,  Effective fertility: 70%, Confidence level: 90%")
ggsave(plot2Dann, file = "plot2D_annotated.pdf")
```

# Wrap-up 

```{r}
remove_labels_legend <- theme(
  axis.title.x=element_blank(),
  axis.text.x=element_blank(),
  #axis.ticks.x=element_blank(),
  axis.title.y=element_blank(),
  #axis.text.y=element_blank(),
  #axis.ticks.y=element_blank(),
  #legend.position = "none",
  title = element_blank()
  )

empty_plot <- ggplot() + theme_void()

plot2B_hist_empty <- plot2B_hist + remove_labels_legend
plot2B_contour_empty <- plot2B_contour + theme(
  axis.title.y=element_blank(),
  title = element_blank()
  )
plot2A_empty <- plot2A + remove_labels_legend
#plot2A_empty
plot2B_empty <- plot2B + remove_labels_legend
#plot2B_empty
plot2C_empty <- plot2C + remove_labels_legend
plot2D_empty <- plot2D + theme(
  axis.title.y=element_blank(),
  title = element_blank()
  )

bb <- ggarrange(plot2B_hist_empty, 
                plot2B_contour_empty + scale_color_brewer(palette = "Dark2"),
                    ncol = 1, nrow = 2, heights = c(1,3))
bb
#ggarrange(list(plot2B_hist_empty,
left_panel <- ggarrange(
  plotlist = list(
      bb,
      empty_plot,
      plot2A + theme(
  #axis.ticks.x=element_blank(),
  axis.title.y=element_blank(),
  #axis.text.y=element_blank(),
  #axis.ticks.y=element_blank(),
  #legend.position = "none",
  title = element_blank()
  )), 
  ncol=1, 
  nrow = 3,
  heights = c(1.6,0.1,1))

right_panel <- ggarrange(
  plotlist = list(
    empty_plot,
      plot2C_empty, 
      empty_plot,
      plot2D_empty), 
  ncol=1, 
  nrow = 4,
  heights = c(0.1,1,0.3,1.6))
          #ncol=1)

figure2 <- ggarrange(left_panel, empty_plot, right_panel, ncol=3, 
                     widths = c(1.6,0.2,1))
figure2
ggsave(figure2, file = "Figure_2_nolabels.pdf",height = 210, width = 297, units = "mm")
```
